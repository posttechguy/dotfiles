#!/bin/zsh

ticket="${1}";
clients=`echo "DISD Doghouse District Zendesk Solotel NBA DTWD VCAT PFD PROV PortAuthorityNSW Gosnells PAN APGML MCC ESC SCV ACCCE AFP APGML RFM Thinkuknow MissingPersons Laundy CCV VDWC DGS DPN JustAuto NHPO Revise LotteryWest SBDC WNRM" | tr ' ' '\n'`;
zendesks=`echo "Nillumbik Murrindindi ANC3D ProductivityCommission Capire" | tr ' ' '\n'`;
comments=`echo "Standup District Triage Perform InitResponse InitResponse-Investigate Training AC Investigate Estimate QA PR Release Pre-release Followup Comms QueueSweep Go-Live Confluence Sync SSL" | tr ' ' '\n'`;
times=`echo "5m 10m 15m 20m 25m 30m 45m 60m 75m 90m 105m 120m 180m 240m 300m" | tr ' ' '\n'`;
comms=`echo "none Team Client Team/Client" | tr ' ' '\n'`

# declare -A zendesks_tickets
# zendesks_tickets['Nillumbik']='DISTCORE-1947'
# zendesks_tickets['Murrindindi']='DISTCORE-1948'
# zendesks_tickets['ANC3D']='DISTCORE-1468'
# zendesks_tickets['ProductivityCommission']='DISTCORE-1949'
# zendesks_tickets['Capire']='DISTCORE-1950'

qualify_ticket()  {
    ticket="${1}";
    regex="^[[:digit:]]"

    if [[ $ticket =~ $regex ]]; then
        echo "SUPPORTDESK-${ticket}"
    else
        echo "$ticket"
    fi
}

function get_log_time() {

    log_time="$1"

    local total_hours=0
    local hours=0
    local minutes=0

    # Parse hours and minutes using Zsh's built-in regular expression matching
    if [[ "$log_time" =~ ([0-9]+)h ]]; then
        hours="${match[1]}"
    fi

    if [[ "$inplog_timeut" =~ ([0-9]+)m ]]; then
        minutes="${match[1]}"
    fi

    # Convert minutes to hours
    decimal_minutes=$(echo "scale=2; $minutes / 60" | bc)

    # Calculate total decimal hours
    total_hours=$(echo "scale=2; $hours + $decimal_minutes" | bc)

  #  echo "$total_hours"

    case $log_time in
        5m)
            echo "0.08"
            ;;
        10m)
            echo "0.17"
            ;;
        15m)
            echo "0.25"
            ;;
        20m)
            echo "0.33"
            ;;
        25m)
            echo "0.42"
            ;;
        30m)
            echo "0.50"
            ;;
        45m)
            echo "0.75"
            ;;
        60m)
            echo "1.00"
            ;;
        75m)
            echo "1.25"
            ;;
        90m)
            echo "1.50"
            ;;
        105m)
            echo "1.75"
            ;;
        120m)
            echo "2.00"
            ;;
        180m)
            echo "3.00"
            ;;
        240m)
            echo "4.00"
            ;;
        300m)
            echo "5.00"
            ;;
    esac
}

# Function to handle user input
function get_comment() {
    t="$1"
    q="$2"
    c="$3"
  #  tr="$4"
    lt="$4"
    nowdatetime=$(date +"%d-%b-%Y %H:%M") # 10/31/2019
    cm="$5"
    desc="$6"
    desk="$7"

        # Zendesk)
        #     comment="${$zendesks_tickets['$desk']},${nowdatetime},${lt},${c} ZenDesk-${t} Triage - ${desc}|${cm}"
        #     ;;
    case $q in
        Triage)
            comment="${t},${nowdatetime},${lt},${c} Triage - ${desc}|${cm}"
            ;;
        Sync)
            comment="${t},${nowdatetime},${lt},${c} Sync DB/files|${cm}"
            ;;
        Confluence)
            comment="${t},${nowdatetime},${lt},Confluence updates"
            ;;
        District)
            comment="DISTCORE-1883,${nowdatetime},${lt},QA|${t}|${cm}"
            ;;
        Comms)
            comment="${t},${nowdatetime},${lt},${c} - ${cm}"
            ;;
        Pre-release)
            comment="${t},${nowdatetime},${lt},${c} Pre-release notes|TBA Schedule|Smoke tests|${cm}"
            ;;
        Release)
            comment="${t},${nowdatetime},${lt},${c} Release notes|Deploy to production|Smoke testing|${cm}"
            ;;
        QA)
            comment="${t},${nowdatetime},${lt},${c} QA|${desc}|${cm}"
            ;;
        PR)
            comment="${t},${nowdatetime},${lt},${c} PR|${cm}"
            ;;
        Estimate)
            comment="${t},${nowdatetime},${lt},${c} Estimate|${cm}"
            ;;
        AC)
            comment="${t},${nowdatetime},${lt},${c} Acceptance criteria|${cm}"
            ;;
        Investigate)
            comment="${t},${nowdatetime},${lt},${c} Investigate|${cm}"
            ;;
        QueueSweep)
            comment="${t},${nowdatetime},${lt},${c} Queue sweep"
            ;;
        InitResponse)
            comment="${t},${nowdatetime},${lt},${c} Initial response|${cm}"
            ;;
        Training)
            comment="${t},${nowdatetime},${lt},${c} Training|${cm}"
            ;;
        Perform)
            comment="${t},${nowdatetime},${lt},${desc}|${cm}"
            ;;
        Followup)
            comment="${t},${nowdatetime},${lt}|Release followup|${cm}"
            ;;
        Go-Live)
            comment="${t},${nowdatetime},${lt}|Go Live|${cm}"
            ;;
        InitResponse-Investigate)
            comment="${t},${nowdatetime},${lt},${c} Initial response/Investigate|${cm}"
            ;;
    esac

    echo "${comment}";
}

function get_logfile() {
    fd=$(date +%Y-%m-%d); # 2019-06-28
    md=$(date +%m-%B);    # 06-June
    yd=$(date +%Y);       # 2019
    history_root="/Users/${USER}/Documents/History";
    templatefile="${history_root}/template.log";
    logfile="${history_root}/${yd}/${md}/${fd}.md";

    if [ ! -d "${history_root}/${yd}/${md}" ]; then
        mkdir -p "${history_root}/${yd}/${md}";
    fi

    if [ ! -f "${logfile}" ]; then
        touch "${logfile}";
        chmod 777 "${logfile}";
        cat "$templatefile" > "$logfile";
   fi

    echo "${logfile}"
}

ticket=$(qualify_ticket "${ticket}");
client=`printf "${clients}" | fzf`
zendesk="";

if printf $clients | grep -qs $client; then
 # all good
     if [ "$client" = "Zendesk" ]; then
       zendesk=`printf "${zendesks}" | fzf`
    fi
else
    echo "Failed to get a client";
    exit
fi

comment_type=`printf "${comments}" | fzf`
if printf $comments | grep -qs $comment_type; then
    if [ "$comment_type" = "Triage" ] || [ "$comment_type" = "Perform" ]; then
       echo "Additional text for description: ";
       read desc_desc;
       echo "This is what you typed as a description: $desc_desc";
    fi
else
    echo "Failed to get a ticket type";
    exit
fi

log_time_decimal=""
log_time=`printf "${times}" | fzf`
if printf $times | grep -qs $log_time; then
  log_time_decimal=$(get_log_time "${log_time}")
else
    echo "Failed to get a log time";
    exit
fi

# # Prompt user for input
# echo "Enter log time (e.g., '1h 30m'):"
# read log_time

# # Check if input is empty
# if [[ -z "$log_time" ]]; then
#     echo "No time input provided. Exiting."
#     exit 1
# fi

# # Call the function with the user input
# log_time_decimal=$(get_log_time "$log_time")
# echo "Decimal time for '$log_time' is: $log_time_decimal"

comms_text=""
comm=`printf "${comms}" | fzf`
comms_text=""

if printf $comms | grep -qs $comm; then
    comms_text="Communication with ${comm}"
else
    echo "Failed to get a communications";
    exit
fi
    echo "${client}";
 #   exit
# if [ $comms_text == "Communication with none" ] then
#     comms_text=""
# fi

# echo "$ticket: $comment_type $client ${log_time_decimal} ${comms_text}"

comment=$(get_comment "$ticket" "$comment_type" "$client" "${log_time_decimal}" "${comms_text}" "${desc_desc}" "${zendesk}")
logfile=$(get_logfile)

echo "${comment}" >> "${logfile}"
echo "Go to file:///${logfile}"
